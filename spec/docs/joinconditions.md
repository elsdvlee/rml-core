# Joins

A <dfn>Referencing Object Map</dfn> (`rml:ReferencingObjectMap`) allows
using the subject generated by the [Subject Map]() (`rml:SubjectMap`)
of the referenced [Triples Map]() (`rml:TriplesMap`).
Since the two triples maps (`rml:TriplesMap`) may be based on
different logical sources (`rml:LogicalSource`),
this may require a join between the logical sources (`rml:LogicalSource`).
This is not restricted to 1:1 joins.

## Referencing Object Map

A [Referencing Object Map] (`rml:ReferencingObjectMap`) is represented by a resource that:

* has exactly one [Parent Triples Map]() (`rml:parentTriplesMap`) property,
  whose value MUST be a Triples Map (`rml:TriplesMap`).
* MAY have one or more [Join Conditions]()  (`rml:joinCondition`) properties.

The [Referencing Object Map]() (`rml:ReferencingObjectMap`)
is constructed with the subject of the [Parent Triples Map]() (`rml:parentTriplesMap`).

```
<#TM1> 
    rml:logicalSource <LS1> ;
    rml:subjectMap <#SM1> ;
    rml:predicateObjectMap [
        rml:predicateMap <#PM1> ;
        rml:objectMap [ rml:parentTriplesMap <#TM2> ] ]. 

<#TM2> 
    rml:logicalSource <LS2> ;
    rml:subjectMap <#SM2> ;
    rml:predicateObjectMap [
        rml:predicateMap <#PM2> ;
        rml:objectMap <#OM2> ] .
```

## Join Condition

A [Join Condition]() is represented by a resource that
has exactly one value for each of the following two properties:

* a [child map]() (`rml:childMap`),
  whose value is an [Expression Map]() (`rml:ExpressionMap`), which
  MUST include references that exists in the [Logical Source]()
  of the [Triples Map]() that contains the [Referencing Object Map]()
  or it should have a constant value.

* a [parent map]() (`rml:parentMap`),
  whose value is an [Expression Map]() (`rml:ExpressionMap`), which,
  as the join condition's parent map,
  MUST include references that exists in the [Logical Source]()
  of the [Referencing Object Map]()'s [Parent Triples Map]()
  or it should have a constant value.

```
<#TM1> 
    rml:logicalSource <LS1> ;
    rml:subjectMap <#SM1> ;
    rml:predicateObjectMap [
        rml:predicateMap <#PM1> ;
        rml:objectMap [ 
            rml:parentTriplesMap <#TM2> ;
            rml:joinCondition [
                rml:childMap [ rml:reference "..."];
                rml:parentMap [ rml:template "..."]; 
            ] ] ]. 

<#TM2> 
    rml:logicalSource <LS2> ;
    rml:subjectMap <#SM2> .
```

### Shortcuts

If the [Child Map]() (`rml:ChildMap`) is a reference-valued [Expression Map]() (`rml:ExpressionMap`),
then the `rml:child` shortcut could be used.

Similarly, if the [Parent Map]() (`rml:ParentMap`) is a reference-valued [Expression Map]() (`rml:ExpressionMap`),
then the `rml:child` shortcut could be used.

```
<#TM1> 
    rml:logicalSource <LS1> ;
    rml:subjectMap <#SM1> ;
    rml:predicateObjectMap [
        rml:predicateMap <#PM1> ;
        rml:objectMap [ 
            rml:parentTriplesMap <#TM2> ;
            rml:joinCondition [
                rml:child "..." ;
                rml:parent "..."]; 
            ] ] ]. 

<#TM2> 
    rml:logicalSource <LS2> ;
    rml:subjectMap <#SM2> .
```
## Join types

If the [Logical Source]() of the [Triples Map]() that contains the [Referencing Object Map]() 
and the [Logical Source]() of the [Referencing Object Map]()'s [Parent Triples Map]() are not identical, 
then the referencing object map must have at least one join condition.

A [Logical Source]() is considered as identical to another [Logical Source]() 
when the set of objects at the end of the property paths starting with `rml:source` and starting with `rml:iterator` are identical. 
In below examples `<LS1>` and `<LS2>` are identical, but `<LS1>` and `<LS3>` are not identical. 
```
<LS1>
    a rml:LogicalSource; 
    rml:source <S1>;
    rml:referenceFormulation rml:JSONPath;
    rml:iterator "$.jsonpath.expression".
<S1> 
    a rml:Source, void:Dataset;
    void:dataDump <file:///data/dump.nt>. 
    
<LS2>
    a rml:LogicalSource; 
    rml:source <S2>;
    rml:referenceFormulation rml:JSONPath;
    rml:iterator "$.jsonpath.expression".
<S2> 
    a rml:Source, void:Dataset;
    void:dataDump <file:///data/dump.nt>.   
   
<LS3>
    a rml:LogicalSource; 
    rml:source <S1>;
    rml:referenceFormulation rml:JSONPath;
    rml:iterator "$.jsonpath.expression2".   
```

```
<LS1>
    a rml:LogicalSource; 
    rml:source [ a rml:Source, a csvw:Table
        csvw:url "/absolute/path/to/data.csv";
    ];
    rml:referenceFormulation rml:CSV.
    
<LS2>
    a rml:LogicalSource; 
    rml:source <S2>;
    rml:referenceFormulation rml:CSV.
    
<S2> 
   a rml:Source, a csvw:Table
   csvw:url "/absolute/path/to/data.csv".
  
<LS3>
    a rml:LogicalSource; 
    rml:source [ a rml:Source, a csvw:Table
        csvw:url "/relative/path/to/data.csv";
    ].
    rml:referenceFormulation rml:CSV.  
```

If the [Referencing Object Map]() has no join condition 
(which is only allowed when the [Logical Source]() of the [Triples Map]() that contains the [Referencing Object Map]()
and the [Logical Source]() of the [Referencing Object Map]()'s [Parent Triples Map]() are identical), a natural join is executed. 
In reality this means that the [Logical Source]() is used in its original form when generating the related RDF triples.   

If the [Referencing Object Map]() has one or more join conditions, an inner join is executed. 
The related RDF triples are generated using the [=n-ary Cartesian product=] 
of the logical iteration of the [Logical Source]() of the [Triples Map]() that contains the [Referencing Object Map]()
and the logical iteration of the [Logical Source]() of the [Referencing Object Map]()'s [Parent Triples Map](), and
retaining only the combination of those logical iterations for which the values of the [Child Map]() and [Parent Map]() of each join condition are identical.

**NOTE**
If the [Referencing Object Map]() has no join condition and the [Logical Source]() of the [Triples Map]() that contains the [Referencing Object Map]()
and the [Logical Source]() of the [Referencing Object Map]()'s [Parent Triples Map]() are not identical, the mapping engine MUST report an error.
